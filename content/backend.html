<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Backend – NOAA quarto simple</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../content/frontend.html" rel="next">
<link href="../content/tech_overview.html" rel="prev">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../content/backend.html">Backend</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../img/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      <div class="sidebar-tools-main tools-wide">
    <a href="https://nomads.ncep.noaa.gov/pub/data/nccf/com/pcpanl/prod/" title="Stage IV NOMADS" class="quarto-navigation-tool px-1" aria-label="Stage IV NOMADS"><i class="bi bi-globe"></i></a>
    <a href="https://github.com/stg4-texas-24hr-ga/stg4-texas-24hr-ga" title="Stage IV repo" class="quarto-navigation-tool px-1" aria-label="Stage IV repo"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Home</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/stg4-product.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Stage IV precipitation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/tech_overview.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tech overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/backend.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Backend</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/frontend.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Frontend</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/historical-builds.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Historical Build</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/roadmap.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Roadmap</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../content/about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-repositories" id="toc-the-repositories" class="nav-link active" data-scroll-target="#the-repositories">The Repositories</a></li>
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">Notes</a>
  <ul class="collapse">
  <li><a href="#delivery-of-stage-iv-data" id="toc-delivery-of-stage-iv-data" class="nav-link" data-scroll-target="#delivery-of-stage-iv-data">Delivery of Stage IV data</a></li>
  <li><a href="#grib2-data-format" id="toc-grib2-data-format" class="nav-link" data-scroll-target="#grib2-data-format">GRIB2 data format</a></li>
  <li><a href="#containers-and-orchestration" id="toc-containers-and-orchestration" class="nav-link" data-scroll-target="#containers-and-orchestration">Containers and Orchestration</a></li>
  <li><a href="#aws-s3-and-apache-arrow.parq" id="toc-aws-s3-and-apache-arrow.parq" class="nav-link" data-scroll-target="#aws-s3-and-apache-arrow.parq">AWS S3 and Apache Arrow/.parq</a></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Backend</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This section of the webpage is where I’m keeping notes on specific aspects of the project. It’s a little bit of a hodgepodge.</p>
<section id="the-repositories" class="level2">
<h2 class="anchored" data-anchor-id="the-repositories">The Repositories</h2>
<p>The details on how the containers are constructed and run through GitHub Actions are contained in the repositories themselves. I have a GitHub organization named ‘stg4-texas-24hr-ga’, this github org is owned by my main github ‘cfurl’. The benefit here is a) I can separate production code base from my messy repository and b) when an action run fails it hits my main email - which is shared with the cfurl repo. Here is a description of what is in those repos:</p>
<ol type="1">
<li><p>‘stg4-texas-24hr-ga’ <a href="https://github.com/stg4-texas-24hr-ga/stg4-texas-24hr-ga">Public Github repo</a> for this website. There are a bunch of good Quarto build examples <a href="https://github.com/mcanouil/awesome-quarto?tab=readme-ov-file">here</a> along with instructions on how to turn your site into a CI/CD system that builds daily. This website is a built off of a simple template provided by <a href="https://github.com/nmfs-opensci/NOAA-quarto-simple">NOAA</a>. The website is static.</p></li>
<li><p>‘stg4-texas-24hr-backend-actions’ <a href="https://github.com/stg4-texas-24hr-ga/stg4-texas-24hr-backend-actions">Private Github repo</a> that contains the docker-compose.yml which controls container linking and orchestration, and the compose-workflow.yml which controls the triggering of the daily run.</p></li>
<li><p>‘stg4-texas-24hr-docker’ <a href="https://github.com/stg4-texas-24hr-ga/stg4-texas-24hr-docker">Private Github repo</a> that contains the codebase and the Dockerfile image build instructions to create each of the images. My typical workflow is I’ll develop in a separate sandbox repo. When I have the code working on an .Rproj relative path basis, I’ll amend the code to work with container paths, build the image, place on Docker Hub. I take the container path code, Dockerfile, and docker_file_build_instructions.txt and place in this repo. Everything you need to build the code from scratch (or ammend!) is in this repo.</p></li>
<li><p>‘stg4-texas-24hr-frontend-actions’ <a href="https://github.com/stg4-texas-24hr-ga/stg4-texas-24hr-frontend-actions">Private Github repo</a> that contains a Github actions daily website build connected to Posit Cloud Connect. The Github actions makes a daily commit, this triggers a PCC website build, and a new map is shown on the frontend. I’m almost positive I can delete this, it’s deprecated.</p></li>
</ol>
</section>
<section id="notes" class="level2">
<h2 class="anchored" data-anchor-id="notes">Notes</h2>
<section id="delivery-of-stage-iv-data" class="level3">
<h3 class="anchored" data-anchor-id="delivery-of-stage-iv-data">Delivery of Stage IV data</h3>
<p>Stage IV data are packaged as GRIB2 files are available each in 1-hr, 6-hr, and 24-hr files. The 6 and 24 hour files are summed from the one hour files. Presently, I’m working with a 24-hr file and pulls daily. I have 1-hr data processed for Texas for the entire period of record from 2002-2023 (or 2024), this is what I’ve been giving to Hatim.</p>
<p>Stage IV data are available in near real-time on NOMADS at :55 past the hour. For example, hourly rainfall ending 2:00 (representing 1:00-2:00) are available at 2:55. Twenty-four hour data are available from 12:00 - 12:00 UTC (available at 12:55 UTC). Data for the last 14 days are kept on NOMADS after which they are cycled off. The real-time NOMADS site is available <a href="https://nomads.ncep.noaa.gov/pub/data/nccf/com/pcpanl/prod/">here</a>. Note, there are .01h, .06hr, and .24hr files for CONUS, pr (Puerto Rico), and ak (Alaska).</p>
<p>After the near real-time file drop, an additional rerun at 30h after valid time (18:55Z) is available to supplement 24-hr mosaics if RFCs need to update their QPEs or make changes. Personal communication with the WGRFC indicates that this is done very infrequently.</p>
<p>Since at least 2012 when I started tinkering with the archived Stage IV data, the historical datasets were kept at <a href="https://data.eol.ucar.edu/cgi-bin/codiac/fgr_form/id=21.093">data.eol.ucar</a>. As of summer 2025, the data have been moved to <a href="https://rda.ucar.edu/datasets/d507005/dataaccess/">rda.ucar.edu</a>. At this new archive location they are tarring together Stage IV data on monthly increments. The data appear to be coming available around the 20th of the next month (for example August data available ~ September 20th).</p>
<p>Routines for manual processing of the data are contained in this <a href="https://github.com/cfurl/manual_stg4_proces">Private repo</a>. It’s decently complete, but I really should go build it up since I do this work infrequently now.</p>
</section>
<section id="grib2-data-format" class="level3">
<h3 class="anchored" data-anchor-id="grib2-data-format">GRIB2 data format</h3>
<p>As previously described, Stage IV data are stored in GRIB2 binary format. Stage IV precipitation has been packaged in both the GRIB1 format (until July 2020) and currently resides in the GRIB2 format. The processing procedures and wgrib.exe utility are completely different between GRIB1 and GRIB2. Again, could use some more documentation on how to build out historical records if I ever needed to do this outside of Texas.</p>
</section>
<section id="containers-and-orchestration" class="level3">
<h3 class="anchored" data-anchor-id="containers-and-orchestration">Containers and Orchestration</h3>
<p>Building an image that simply spawns a container to run a script with few libraries is very straightforward. It begins to get complicated when your image and resulting containers begin to rely on varied technology streams. Using the ‘scraper’ container as an example, pasted below is the ‘Dockerfile’ that you use to build the image. Each image starts from another image, in this case the FROM command downloads a specific version of r from the ‘rocker’ repository. This image or layer, contains all of the dependencies needed to run r 4.2.2, next I create a series of folders in my image, then I run an R command to install.packages, assign working directory, and lastly copy code from my local computer to the image.</p>
<p>Now everytime I call on that image a container is spawned that runs ‘stg4_24hr_scraper.R’ in the proper R environment with the proper packages installed. This script simply downloads the latest GRIB2 file and puts it in a shared volume where the next container can interact with the file.</p>
<p>Build that image in PowerShell: docker image build –tag stg4_24hr_scraper . Run that image in PowerShell: docker container run -v //c/stg4/stg4-texas-24hr-docker/scraper/data:/home/data stg4_24hr_scraper</p>
<p>You can then inspect you container through PowerShell to see if your file downloaded.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>FROM rocker<span class="sc">/</span>r<span class="sc">-</span>ver<span class="sc">:</span><span class="dv">4</span>.<span class="fl">2.2</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>RUN mkdir <span class="sc">-</span>p <span class="sc">/</span>home</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>RUN mkdir <span class="sc">-</span>p <span class="sc">/</span>home<span class="sc">/</span>code</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>RUN mkdir <span class="sc">-</span>p <span class="sc">/</span>home<span class="sc">/</span>data</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>RUN R <span class="sc">-</span>e <span class="st">"install.packages(c('dplyr','stringr','rvest'))"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>WORKDIR <span class="sc">/</span>home</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>COPY <span class="sc">/</span>code<span class="sc">/</span>stg4_24hr_scraper.R <span class="sc">/</span>code<span class="sc">/</span>stg4_24hr_scraper.R</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>CMD Rscript <span class="sc">/</span>code<span class="sc">/</span>stg4_24hr_scraper.R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The order of the containers and their dependencies are managed through Docker Compose. I still build “docker image build –tag stg4_24hr_scraper .”, test “docker container run -v //c/stg4/stg4-texas-24hr-docker/scraper/data:/home/data stg4_24hr_scraper”, tag, push, pull containers manually in PowerShell, but to put it in production you’ll want it in a docker-compose.yml. These are simple files to write, in general, getting the guts of the image correct is much more difficult that putting containers together.</p>
<p>Below is a piece of the docker-compose.yml used int the stg4 orchestration. For the GitHub Actions CI/CD this must reside at the root folder of the GA repository. When you work in this .yml you have to mind your indentations, runs fail fast so it’s nice, but very picky.</p>
<p>The ‘scraper’ container is the simplest of the bunch. Docker-compose already knows ‘cfurl/stg4_24hr_scraper:v1’ is referring to Docker Hub repo. The ‘volumes’ line indicates ‘shared volume between containers’:‘local path in specific container’. In the scraper example, data are downloaded from the web to /home/data, this path is automatically linked to the ‘st4_data’ volume so the rest of the individual containers can pick it up.</p>
<p>The ‘env_file’ is how AWS credentials are injected at Runtime. The GitHub Actions CI/CD builds the docker-compose environment daily and creates an AWS runtime each day. AWS credentials are stored securely in the GitHub repo. I learned the hard way it’s a bad idea to layer credentials into you Docker Image that lives on a repository.</p>
<p>Another note, when you want to hardwire some assets into your image, for example shapefiles or a .csv, you can’t place them in a folder named /data and then link your shared volume to that path: - st4_data:/home/data. It will overwrite it. When hardwiring assets in container keep them separate from shared volumes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>services<span class="sc">:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  scraper<span class="sc">:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    image<span class="sc">:</span> cfurl<span class="sc">/</span>stg4_24hr_scraper<span class="sc">:</span>v1</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    container_name<span class="sc">:</span> scrape24</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    volumes<span class="sc">:</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> st4_data<span class="sc">:</span><span class="er">/</span>home<span class="sc">/</span>data</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  wgrib2<span class="sc">:</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    image<span class="sc">:</span> cfurl<span class="sc">/</span>sondngyn_wgrib2<span class="sc">:</span>v1</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    container_name<span class="sc">:</span> wgrib2</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    command<span class="sc">:</span> <span class="st">"wgrib2_commands.sh"</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    depends_on<span class="sc">:</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      scraper<span class="sc">:</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        condition<span class="sc">:</span> service_completed_successfully</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    volumes<span class="sc">:</span> </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> st4_data<span class="sc">:</span><span class="er">/</span>srv<span class="sc">/</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> st4_data<span class="sc">:</span><span class="er">/</span>opt<span class="sc">/</span>    </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  parqs3<span class="sc">:</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    image<span class="sc">:</span> cfurl<span class="sc">/</span>stg4_24hr_parq_s3<span class="sc">:</span>v1</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    container_name<span class="sc">:</span> parqs3</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    depends_on<span class="sc">:</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>      wgrib2<span class="sc">:</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        condition<span class="sc">:</span> service_completed_successfully</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    volumes<span class="sc">:</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> st4_data<span class="sc">:</span><span class="er">/</span>home<span class="sc">/</span>data</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    env_file<span class="sc">:</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span> .env</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>volumes<span class="sc">:</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  st4_data<span class="sc">:</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is the list of containers chained together in the docker-compose.yml all live on Docker Hub repository:</p>
<ol type="1">
<li>cfurl/stg4_24hr_scraper:v1</li>
<li>cfurl/sondngyn_wgrib2:v1</li>
<li>cfurl/stg4_24hr_parq_s3:v2</li>
<li>cfurl/stg4_24hr_daily_stat_update:v1</li>
<li>cfurl/stg4_24hr_daily_make_map:v1</li>
<li>cfurl/stg4_24hr_daily_make_hyet:v1</li>
</ol>
<p>The docker-compose.yml gets triggered each day via Github Actions with the standard ‘docker-compose up’ command. Github Actions is controlled by a yml file placed in .github/workflows (path has to be named this for Actions to work). There I have my compose-workflow.yml. This took a long time to set up prior to ChatGPT, but the basic steps are you tell it when to fire:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>on<span class="sc">:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  schedule<span class="sc">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span> cron<span class="sc">:</span> <span class="st">'45 13 * * *'</span>  <span class="co"># Runs daily at 13:45 UTC</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  workflow_dispatch<span class="sc">:</span>       <span class="co"># Also allow manual triggering</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>then a series of commands that install Docker in the virtual environment, assign AWS credentials, and lastly run ‘docker-compose up’ which starts the docker-compose.yml in the root directory. Important that the AWS credentials are managed through Github via the repository, and only injected at runtime. I still to this day have never added a new imaage to the compose workflow and had Github Actions run it successfully. Lot’s of debugging by examining the logs of your ‘Actions’ tab in the Github repository. It’s nice to drop some checkin points in your scripts in the containers to print ‘sucessfully this far’ to help know where you’re crashing.</p>
</section>
<section id="aws-s3-and-apache-arrow.parq" class="level3">
<h3 class="anchored" data-anchor-id="aws-s3-and-apache-arrow.parq">AWS S3 and Apache Arrow/.parq</h3>
<p>The last 4 containers all interact with AWS S3 storage buckets. I have 7 buckets right now on S3, here is what they contain, later with individual scripts I’ll describe what writes to them:</p>
<ol type="1">
<li>stg4-edwards-24hr-historical: parquet files of stg4 data from 2002-present across EAR.</li>
<li>stg4-edwards-daily-maps: storage for .png maps generated daily (hyet, 24hr, ytd)</li>
<li>stg4-edwards-daily-stats-24hr: parquet of daily basin averaged precipitation for all 10 subbasins</li>
<li>stg4-edwards-latest: storage for most recent .png maps generated daily (hyet, 24hr, ytd). Only ever holds maps for most recent day.</li>
<li>stg4-texas-24hr: parquet files of stg4 data from 2002-present across Texas.</li>
<li>stg4-texas-24hr-backup: ChatGPT assisted ‘snapshot’ of “stg4-texas-24hr”</li>
<li>stg4-texas-24hr-historical: parquet files of stg4 data from 2002-present across Texas.</li>
</ol>
<p>Arrow</p>
</section>
<section id="images" class="level3">
<h3 class="anchored" data-anchor-id="images">Images</h3>
<section id="image-1---scraper---cfurlstg4_24hr_scraperv1" class="level4">
<h4 class="anchored" data-anchor-id="image-1---scraper---cfurlstg4_24hr_scraperv1">Image 1 - scraper - cfurl/stg4_24hr_scraper:v1</h4>
<p>This container takes the current system date and time, builds the appropriate NOMADS url based off of date and time, downloads the 24hr GRIB2 conus file at that url, and writes a shell script based off of url filename that is used in the next container to inject prompts to wgrib2.exe. Both the shell script and the GRIB2 file reside in a shared ephemeral storage volume that all containers are linked to.</p>
<p>External writes: none</p>
<p>Potential weaknesses: I wrote this script years ago. I should standardize the way way in interact with system time between all images because i do it frequently. Main problem though is if the script is run at night time between (0 - 12:55 UTC) before the most recent stage4 drops the whole thing fails. This hasn’t been a problem becasue my chron job starts at 13:55, but it’w worth considering.</p>
</section>
<section id="image-2---wgrib2---cfurlsondngyn_wgrib2v1" class="level4">
<h4 class="anchored" data-anchor-id="image-2---wgrib2---cfurlsondngyn_wgrib2v1">Image 2 - wgrib2 - cfurl/sondngyn_wgrib2:v1</h4>
<p>I took this image from sondngyn and packaged it in my own repository so it won’t go away. This is just wgrib2.exe built into a container. I execute my shell file written with the first container that supplies the commands to wgrib2.exe. The output binary to .txt format for the radar data is captured in the shared volume.</p>
<p>External writes: none</p>
<p>Potential weaknesses: I need to learn how to use Pygrib when i start working with other products. The encapsulation of the stg4 product in the GRIB2 file format is dead simple. I just export to text. File sizes cooperate and there aren’t a lot of complications of what’s in the GRIB2 file. If i start to work with other products like HRRR, GFS, etc I need to undertand details of how to chunk data, access specific layers etc.</p>
</section>
<section id="image-3---parqs3---cfurlstg4_24hr_parq_s3v2" class="level4">
<h4 class="anchored" data-anchor-id="image-3---parqs3---cfurlstg4_24hr_parq_s3v2">Image 3 - parqs3 - cfurl/stg4_24hr_parq_s3:v2</h4>
<p>This docker container reads the .txt dump of radar data, tidy’s the GRIB2 .txt output, clips to area of interest (Texas and EAR), and then writes .parquet files that are partitioned by (year, month, day) to three S3 buckets.</p>
<p>A note, you would probably have to partition by hour if you do this hourly, because you can’t append a .parquet file to existing data because of how it is written on the disk. Your partitions have to be separate when you are doing this in an automated fashion.</p>
<p>External writes: “stg4-texas-24hr”; “stg4-texas-24hr-historical”; “stg4-edwards-24hr-historical”</p>
<p>Potential weaknesses: You left_join your .csv of of radar bins that are in the Texas buffer with the individual radar bins for that day of data. You are joining by ‘lat’ and ‘lon’, so you have to make sure that those are unique to each other down to the decimal point so you don’t throw and NA. Seems to be working fine, but i recall some pain when working through the grid. A note on parquet files, you would probably have to partition by hour if you do this hourly, because you can’t append a .parquet file to existing data because of how it is written on the disk - it will overwrite. Your partitions have to be separate when you are doing this in an automated fashion.</p>
</section>
<section id="image-4---dailystat---cfurlstg4_24hr_daily_stat_updatev1" class="level4">
<h4 class="anchored" data-anchor-id="image-4---dailystat---cfurlstg4_24hr_daily_stat_updatev1">Image 4 - dailystat - cfurl/stg4_24hr_daily_stat_update:v1</h4>
<p>This container pulls radar data from the most recent day (written just before in container 3) and calculates basin averaged precipitation for the 10 subbasins. Within the image, “/home/gis” I have .csv files hardwired that describe area of each radar bin for every basin. Basin avg precip is calculated by solving for volume of water in each radar bin, summing, and then dividing by total area of basin.</p>
<p>External writes: “stg4-edwards-daily-stats-24hr”</p>
<p>Potential weaknesses: Is it time saving to read from “stg4-edwards-24hr-historical” instead of “stg4-texas-24hr”? why do i convert from mm to in in this script?</p>
</section>
<section id="image-5---makemap---cfurlstg4_24hr_daily_make_mapv1" class="level4">
<h4 class="anchored" data-anchor-id="image-5---makemap---cfurlstg4_24hr_daily_make_mapv1">Image 5 - makemap - cfurl/stg4_24hr_daily_make_map:v1</h4>
<p>This image accesses “stg4-texas-24hr” S3 bucket, and creates a tibble of the most recent daily rainfall across the EAA and the ytd across the EAA. The most recent 24hr rainfall is shown on a map highlighting the stream network. The ytd rainfall map shows the individual subbasin and minimizes the stream network. Both maps contain a semi-transparent table in the upper righthand corner of the figure. The legend in the ytd map is dynamic and will scale according to rainfall amounts (ie time of year). I’m curious to see how maps look in january with little rainfall. The 24hr map legend is static. Both maps have assigned/locked color bins. The maps are written to a long-term s3 repository with the date captured in the name and a bucket that contains only the most recent map. The “stg4-edwards-latest” bucket has pretty tight cache control so an individual viewing that link won’t cache it and see a previous rainfall map.</p>
<p>External writes: “stg4-edwards-daily-maps”; “stg4-edwards-latest”</p>
<p>Potential weaknesses: Is it time saving to read from “stg4-edwards-24hr-historical” instead of “stg4-texas-24hr” - probably so? It would make your left_join(rain_24hr, by = “grib_id”)|&gt; go way faster.</p>
</section>
<section id="image-6---makehyet---cfurlstg4_24hr_daily_make_hyetv1" class="level4">
<h4 class="anchored" data-anchor-id="image-6---makehyet---cfurlstg4_24hr_daily_make_hyetv1">Image 6 - makehyet - cfurl/stg4_24hr_daily_make_hyet:v1</h4>
<p>This one access the daily stats written in container 3 and creates a hyetograph for each of the 10 subbasins. The ribbons are controlled by hard-wired statistics built from 2002-2024, these need to be updated manually at end of year. .png files get placed in the same location as the map files.</p>
<p>External writes: “stg4-edwards-daily-maps”; “stg4-edwards-latest”</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/stg4-texas-24hr-ga\.github\.io\/stg4-texas-24hr-ga\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../content/tech_overview.html" class="pagination-link" aria-label="Tech overview">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Tech overview</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../content/frontend.html" class="pagination-link" aria-label="Frontend">
        <span class="nav-page-text">Frontend</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© CC-1.0</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
<p>This page is built with <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>




</body></html>